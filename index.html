import React, { useState, useEffect, useMemo } from 'react';
import { 
    Sparkles, Crown, Heart, Zap, Shield, Smile, MessageCircle, MapPin, 
    CheckCircle, Lightbulb, User, MessageSquare, Lock, Home 
} from 'lucide-react';

// --- Program Data based on the Curriculum Overview ---
const treasureLevels = [
    { 
        id: 1, 
        theme: "Me, Myself, and I", 
        focus: "Discovering Identity", 
        icon: User, 
        color: "bg-pink-100", 
        border: "border-pink-500",
        activities: [
            { id: 'a1', title: "My Unique Gem", prompt: "List three things that make you special and unlike anyone else!", type: 'input' },
            { id: 'a2', title: "Favorite Things Quiz", prompt: "Choose your favorite color, food, and animal to create your personal profile!", type: 'choice' },
        ] 
    },
    { 
        id: 2, 
        theme: "My Superpower: Confidence", 
        focus: "Positive Self-Talk", 
        icon: Sparkles, 
        color: "bg-yellow-100", 
        border: "border-yellow-500",
        activities: [
            { id: 'a1', title: "Affirmation Station", prompt: "Write one confident sentence about yourself to save in your confidence jar!", type: 'input' },
            { id: 'a2', title: "Confidence Walk", prompt: "Practice your superpower pose in the mirror!", type: 'prompt' },
        ] 
    },
    { 
        id: 3, 
        theme: "Dealing with Big Feelings & Bullies", 
        focus: "Resilience & Safety", 
        icon: Shield, 
        color: "bg-purple-100", 
        border: "border-purple-500",
        activities: [
            { id: 'a1', title: "Feelings Check-in", prompt: "How do you feel today? Identify the emotion and pick a calm-down tool.", type: 'choice' },
            { id: 'a2', title: "The Strong Voice", prompt: "Write down three ways you can tell a bully 'STOP' clearly and firmly.", type: 'input' },
        ] 
    },
    { 
        id: 4, 
        theme: "Being a Great Friend", 
        focus: "Empathy and Kindness", 
        icon: Heart, 
        color: "bg-red-100", 
        border: "border-red-500",
        activities: [
            { id: 'a1', title: "Kindness Ripple Log", prompt: "What is one kind thing you did for someone else this week?", type: 'input' },
            { id: 'a2', title: "Empathy Glasses", prompt: "Imagine your friend is sad. What do you think they need right now?", type: 'input' },
        ] 
    },
    { 
        id: 5, 
        theme: "Making and Keeping Friends", 
        focus: "Social Skills", 
        icon: Smile, 
        color: "bg-green-100", 
        border: "border-green-500",
        activities: [
            { id: 'a1', title: "Conversation Starter Drill", prompt: "Practice two ways to say hello to a new person (e.g., 'I like your...').", type: 'prompt' },
            { id: 'a2', title: "Friendship Recipe", prompt: "List the 3 best 'ingredients' for a good friendship (e.g., listening, sharing).", type: 'input' },
        ] 
    },
    { 
        id: 6, 
        theme: "Powerful Communication", 
        focus: "Assertive Voice", 
        icon: MessageCircle, 
        color: "bg-blue-100", 
        border: "border-blue-500",
        activities: [
            { id: 'a1', title: "The 'I Feel' Builder", prompt: "Write one 'I feel...' statement about something that bothered you today.", type: 'input' },
            { id: 'a2', title: "Active Listening Game", prompt: "List the three rules of being a super listener (look, wait, don't interrupt).", type: 'input' },
        ] 
    },
];

const initialProgress = { 1: true, 2: false, 3: false, 4: false, 5: false, 6: false };

/** Treasure Map Navigation Component: Shows all 6 weeks and their completion status. */
const TreasureMap = ({ currentLevel, setLevel, completedLevels }) => {
    return (
        <div className="bg-purple-100 p-4 md:p-6 rounded-2xl shadow-xl border-4 border-purple-300">
            <h2 className="text-xl font-bold mb-4 text-purple-700 flex items-center">
                <MapPin className="w-5 h-5 mr-2" /> Your Adventure Map
            </h2>
            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                {treasureLevels.map((level) => {
                    const isCompleted = completedLevels[level.id];
                    const isActive = level.id === currentLevel;
                    // Level is locked if it's not Week 1 AND the previous week is not complete
                    const isLocked = level.id > 1 && !completedLevels[level.id - 1] && !isCompleted;

                    let statusIcon;
                    if (isCompleted) {
                        statusIcon = <CheckCircle className="w-5 h-5 text-green-500 fill-white" />;
                    } else if (isLocked) {
                        statusIcon = <Lock className="w-5 h-5 text-gray-400" />;
                    } else {
                        statusIcon = <level.icon className="w-5 h-5" />;
                    }

                    return (
                        <button
                            key={level.id}
                            onClick={() => !isLocked && setLevel(level.id)}
                            className={`
                                p-3 rounded-xl transition duration-200 text-center relative
                                ${level.color} border-2 
                                ${isLocked ? 'opacity-50 cursor-not-allowed border-gray-300' : level.border}
                                ${isActive ? 'ring-4 ring-offset-2 ring-purple-500 shadow-lg scale-105' : 'hover:shadow-md hover:scale-[1.02]'}
                            `}
                            disabled={isLocked}
                        >
                            <span className={`absolute top-1 right-1 p-0.5 rounded-full ${isCompleted ? 'bg-white' : ''}`}>
                                {statusIcon}
                            </span>
                            <div className={`text-xl font-extrabold mb-1 ${isActive ? 'text-purple-700' : 'text-purple-600'}`}>
                                W{level.id}
                            </div>
                            <p className="text-xs font-medium text-gray-600 leading-tight">
                                {level.theme}
                            </p>
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

/** Interactive Level Content Component: Displays activities for the selected week. */
const LevelView = ({ levelData, setCompletedLevels }) => {
    // NOTE: In a real app, activityState would be loaded from and saved to Firestore.
    const [activityState, setActivityState] = useState({});
    const [message, setMessage] = useState('');

    // Reset state when a new level is selected
    useEffect(() => {
        setActivityState({});
        setMessage('');
    }, [levelData]);

    const handleInput = (activityId, value) => {
        setActivityState(prev => ({ ...prev, [activityId]: value }));
    };

    const handleSubmit = (activityId, type) => {
        if (type === 'input' && !activityState[activityId]) {
            setMessage('Please write your thoughts before submitting!');
            return;
        }

        // Mark the current activity as done
        setActivityState(prev => ({ ...prev, [`done_${activityId}`]: true }));
        setMessage('Great job! Your answer has been saved to your treasure journal!');
        
        // Logic to check if the entire level is complete
        const allActivities = levelData.activities.map(a => a.id);
        
        // Check if all activities, including the one just submitted, are done
        // We use a short delay to allow the 'Activity Saved!' message to show
        const isLevelComplete = allActivities.every(id => activityState[`done_${id}`] || id === activityId);
        
        if (isLevelComplete) {
            setTimeout(() => {
                setCompletedLevels(prev => {
                    const newProgress = { ...prev, [levelData.id]: true };
                    // Unlock the next level if it exists
                    if (levelData.id < treasureLevels.length) {
                        newProgress[levelData.id + 1] = false; 
                    }
                    return newProgress;
                });
                setMessage(`ðŸŽ‰ Level ${levelData.id} COMPLETE! Level ${levelData.id < treasureLevels.length ? levelData.id + 1 + ' is now unlocked!' : 'You completed the entire program!'}`);
            }, 1500);
        }
    };
    
    const totalActivities = levelData.activities.length;
    const completedActivities = levelData.activities.filter(a => activityState[`done_${a.id}`]).length;
    const progress = (completedActivities / totalActivities) * 100;

    return (
        <div className="mt-8 p-6 bg-white rounded-2xl shadow-2xl border-4 border-purple-500/50">
            <div className={`${levelData.border} ${levelData.color} p-4 rounded-xl mb-4`}>
                <h3 className="text-2xl font-extrabold text-purple-700 mb-1">
                    Week {levelData.id}: {levelData.theme}
                </h3>
                <p className="text-lg text-gray-600 italic">{levelData.focus}</p>
            </div>
            
            <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div 
                    className="bg-green-400 h-2.5 rounded-full transition-all duration-700" 
                    style={{ width: `${progress}%` }}
                ></div>
            </div>

            {levelData.activities.map((activity) => {
                const isDone = activityState[`done_${activity.id}`];

                return (
                    <div key={activity.id} className="mb-6 p-4 border border-gray-200 rounded-lg">
                        <div className="flex justify-between items-center mb-2">
                            <h4 className="text-xl font-semibold text-gray-800 flex items-center">
                                <Lightbulb className="w-5 h-5 mr-2 text-yellow-500" />
                                {activity.title}
                            </h4>
                            {isDone && <CheckCircle className="w-6 h-6 text-green-500" />}
                        </div>
                        <p className="text-gray-600 mb-3">{activity.prompt}</p>

                        {activity.type === 'input' && (
                            <textarea
                                className="w-full p-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition"
                                rows="3"
                                placeholder="Write your beautiful thought here..."
                                value={activityState[activity.id] || ''}
                                onChange={(e) => handleInput(activity.id, e.target.value)}
                                disabled={isDone}
                            ></textarea>
                        )}
                        
                        {/* Mock interactions for non-input types */}
                        {activity.type !== 'input' && (
                             <p className={`p-2 rounded text-sm ${activity.type === 'choice' ? 'bg-purple-50 text-purple-700' : 'bg-yellow-50 text-yellow-700'}`}>
                                {activity.type === 'choice' ? 
                                    '*Mock Choice Activity: Time to reflect and choose your answer!*' : 
                                    '*Mock Reflection Prompt: Practice this skill out loud or in your head!*'
                                }
                            </p>
                        )}

                        <button
                            onClick={() => handleSubmit(activity.id, activity.type)}
                            disabled={isDone}
                            className={`mt-3 py-2 px-4 rounded-full font-bold transition duration-150 shadow-md ${
                                isDone 
                                ? 'bg-green-400 text-white cursor-default' 
                                : 'bg-purple-500 hover:bg-purple-600 text-white'
                            }`}
                        >
                            {isDone ? 'Activity Saved!' : 'Complete Activity'}
                        </button>
                    </div>
                );
            })}
            
            {message && (
                <div className="mt-4 p-3 bg-indigo-50 border border-indigo-300 text-indigo-800 rounded-lg flex items-center">
                    <MessageSquare className="w-5 h-5 mr-2" /> {message}
                </div>
            )}
        </div>
    );
};

/** Portal View: Main orchestrator for the member experience. */
const PortalView = () => {
    // States for the portal functionality
    const [completedLevels, setCompletedLevels] = useState(initialProgress);
    const [currentLevel, setCurrentLevel] = useState(1);
    
    // Auto-select the highest unlocked level when progress changes
    useEffect(() => {
        const highestUnlocked = treasureLevels.reduce((max, level) => {
            if (completedLevels[level.id] || (level.id > 1 && completedLevels[level.id - 1])) {
                return level.id;
            }
            return max;
        }, 1);
        setCurrentLevel(highestUnlocked);
    }, [completedLevels]);

    const currentLevelData = useMemo(() => 
        treasureLevels.find(level => level.id === currentLevel)
    , [currentLevel]);
    
    const setLevel = (id) => {
        setCurrentLevel(id);
        window.scrollTo({ top: 0, behavior: 'smooth' }); 
    }

    return (
        <div className="max-w-7xl mx-auto p-4 md:p-8">
            <h2 className="text-4xl font-extrabold text-gray-800 mb-6 text-center">
                Your Beautiful Treasure Journey
            </h2>
            
            {/* 1. Treasure Map Navigation */}
            <TreasureMap 
                currentLevel={currentLevel} 
                setLevel={setLevel} 
                completedLevels={completedLevels} 
            />

            {/* 2. Level Content */}
            {currentLevelData ? (
                <LevelView 
                    levelData={currentLevelData} 
                    setCompletedLevels={setCompletedLevels}
                />
            ) : (
                <div className="mt-8 text-center p-12 bg-white rounded-xl shadow-md text-xl text-gray-500">
                    Select a level from the map to begin your adventure!
                </div>
            )}
            
            {/* 3. Footer / Encouragement */}
            <div className="mt-12 text-center p-6 bg-purple-50 rounded-xl shadow-inner border border-purple-200">
                <p className="text-purple-700 font-semibold text-lg flex items-center justify-center">
                    <Zap className="w-6 h-6 mr-2 text-yellow-500" fill="gold" />
                    Remember: You are capable, you are kind, and your voice matters!
                </p>
            </div>
        </div>
    );
}

// Simple App Wrapper for demonstration/testing the Portal component
const App = () => (
    <div className="min-h-screen bg-gray-50 font-sans p-4">
        <header className="bg-white shadow-lg p-4 mb-4 rounded-xl text-center">
            <h1 className="text-3xl font-extrabold text-purple-700 flex items-center justify-center">
                <Crown className="w-8 h-8 text-yellow-500 mr-2" fill="gold" />
                Beautiful Treasure Portal (Standalone Demo)
            </h1>
        </header>
        <PortalView />
    </div>
);

export default App;
